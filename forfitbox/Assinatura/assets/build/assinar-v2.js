!function(f){f.fn.vtexSubscription=function(t){var p=f.extend({title:"Escolha a o período:",htmButton:"<span>Assinar</span>",minPrice:2e4,discount:10,discountType:"percentual",showInfo:!0,linkInfo:"Como funciona a assinatura?",shippingDay:[5,15,25],plan:[{frequency:"1",periodicity:"month",text:"Mensal - Todo mês"},{frequency:"2",periodicity:"month",text:"Bimestral - A cada 2 mêses"}],after:"modal",callback:"onpage"},t),s=this,m={init:function(){this.event(),this.setup()},setup:function(){var t=f(".value-field.Similar"),e="",a="",n="";0!=p.discount&&("percentual"==p.discountType?e='<div class="discount">Assine e economize '+p.discount+"%</div>":"nominal"==p.discountType&&(e='<div class="discount">Assine e economize '+p.discount/100+"</div>")),(skuJson.skus[0].available=0<skuJson.skus[0].availablequantity)?(n=skuJson.skus[0].sku,f.each(p.plan,function(t,e){a+='<option value="'+e.frequency+" "+e.periodicity+'">'+e.text+"</option>"}),s.append('<label class="flex" for="Assinar"><input type="radio" class="item-buy" id="Assinar" name="tipo-produto" checked value="'+n+'"><div class="group">'+p.htmButton+e+'<select id="frequency"><option value="0">'+p.title+"</option>"+a+"</select></div></label>"),p.showInfo&&s.append('<a class="link-info show-modal" rel="jn-info">'+p.linkInfo+"</a>"),s.append('<div class="c-row action"><input type="number" value="1" min="1" id="input-custom-quant"><button class="buy buy-subscription" data-sku="'+n+'">Assinar</button></div>'),t.length&&(t=(t=t.text()).replace("?lid=b7b0b83f-2513-4c9d-ac2f-2300f4fc689d","73639"),f.getJSON("/api/catalog_system/pub/products/search?fq=productId:"+t,function(t){console.log(t);var e=t[0].items[0].sellers[0].commertialOffer.AvailableQuantity;0<e&&e<9999?s.prepend('<label class="flex" for="Comprar"><input type="radio" class="item-buy" id="Comprar" name="tipo-produto" value="'+t[0].items[0].itemId+'"><div class="group"><span>Comprar</span></div></label>'):s.prepend('<div class="aviseme" style="display: flex;align-items: center;font-size: 14px;padding: 20px 0;clear: both;line-height: 18px;font-weight: 700;"><svg style="width: 30px;height: 30px;margin: 0 10px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M506.3 417l-213.3-364c-16.33-28-57.54-28-73.98 0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6C502.1 480 522.6 445 506.3 417zM232 168c0-13.25 10.75-24 24-24S280 154.8 280 168v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zM256 416c-17.36 0-31.44-14.08-31.44-31.44c0-17.36 14.07-31.44 31.44-31.44s31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>Produto disponível apenas para assinatura</div>')}))):f("._aviseme").show()},event:function(){f("body").on("change","#frequency",function(){f("input#Assinar").click(),f("#frequency").removeClass("obr").addClass("clt")}),f("body").on("change",".item-buy",function(){var t=f(this).attr("id"),e=f(".action .buy"),a=f(this).val();e.html(t).attr("data-sku",a),"Assinar"==t?(e.addClass("buy-subscription"),f("#frequency").removeClass("obr").addClass("clt")):(f("#frequency").removeClass("obr clt"),e.removeClass("buy-subscription"))}),f("body").on("click",".show-modal",function(t){t.preventDefault();t=f(this).attr("rel");f("."+t).fadeIn(100),f("body").addClass("noScroll")}),f("body").on("click",".hide-modal",function(t){t.preventDefault(),f(this).parents(".ext-modal").hide(),f("body").removeClass("noScroll")}),f("body").on("click",".remove-modal",function(t){t.preventDefault(),f(this).parents(".ext-modal").remove(),f("body").removeClass("noScroll")}),f("body").on("click",".remove-cart-qty",function(t){t.preventDefault();var e=f(this).parents(".cartSkuGroup").find(".select-qty"),t=e.val();1<(t=""==t?2:t)&&e.val(parseInt(t)-1).trigger("change")}),f("body").on("click",".add-cart-qty",function(t){t.preventDefault();var e=f(this).parents(".cartSkuGroup").find(".select-qty"),t=e.val();""==t&&(t=0),e.val(parseInt(t)+1).trigger("change")}),f("body").on("change",".select-qty",function(){var a=parseInt(f(this).parents(".cartSkuGroup").attr("data-index")),n=f(this).val();f(".jn-cart").addClass("load"),setTimeout(function(){vtexjs.checkout.getOrderForm().then(function(t){var e={index:parseInt(a),quantity:parseInt(n)};return vtexjs.checkout.updateItems([e],null,!1)}).done(function(t){f(".ext-modal.recurly").removeClass("load"),m.orderform(t)})},100)}),f("body").on("click",".cartSkuGroup .removeItem",function(){var e=parseInt(f(this).parents(".cartSkuGroup").attr("data-index"));f(".jn-cart").addClass("load"),setTimeout(function(){vtexjs.checkout.getOrderForm().then(function(t){t.items[0];return vtexjs.checkout.removeItems([{index:e,quantity:0}])}).done(function(t){m.orderform(t)})},100)}),f(".wrap-subscription").on("click",".action .buy",function(){var a=f(this).attr("data-sku"),n=f("#input-custom-quant").val();esse=f(this),esse.addClass("load"),setTimeout(function(){if(esse.hasClass("buy-subscription")){var t,e=f("#frequency").val();if("0"==e)return f("#frequency").addClass("obr").focus(),esse.removeClass("load"),!1;e=(t=e.split(" "))[0],t=t[1],values=p.shippingDay,today=new Date,sday=today.getDate(),day=parseInt(sday),purchaseday=values.reduce(function(t,e){return Math.abs(e-day)<Math.abs(t-day)?e:t}),m.buySubscription(a,n,e,t,purchaseday)}else m.buyUnique(a,n)},10)})},buyUnique:function(t,e){f.ajax({type:"GET",url:window.location.origin+"/checkout/cart/add?sku="+t+"&qty="+e+"&seller=1&sc=1",success:function(){"onpage"==p.callback?(minicart.miniCartInit(),f(".carrinho").click()):window.location.href="/checkout#/cart"},error:function(){console.log("Não foi possível adicionar ao carrinho")},complete:function(){f(".buy.load").removeClass("load")}})},buySubscription:function(t,a,e,n,s){var o,i,t=t,r=e,n=n,c=new Date,l=new Date,a=f("#input-custom-quant").val();f(".jn-cart").addClass("load"),l.setDate(c.getDate()+1095);var u={"vtex.subscription.key.frequency":e+" "+n,"vtex.subscription.key.purchaseday":s};setTimeout(function(){f.ajax({type:"GET",url:window.location.origin+"/checkout/cart/add?sku="+t+"&qty=1&seller=1&sc=1",success:function(){vtexjs.checkout.getOrderForm().done(function(t){setTimeout(function(){vtexjs.checkout.getOrderForm().then(function(t){return o=parseInt(t.items.length)-1,vtexjs.checkout.addItemAttachment(o,"vtex.subscription.assinatura",u)}).done(function(t){i=t.orderFormId,1<parseInt(a)&&(e={index:o,quantity:a},vtexjs.checkout.updateItems([e],null,!1));var e={subscriptions:[{itemIndex:o,plan:{frequency:{interval:r,periodicity:n.toUpperCase()},validity:{begin:m.formatDate(c),end:m.formatDate(l)},type:"RECURRING_PAYMENT"}}],expectedOrderFormSections:["items","totalizers","clientProfileData","shippingData","paymentData","sellers","messages","marketingData","clientPreferencesData","storePreferencesData","giftRegistryData","ratesAndBenefitsData","openTextField","commercialConditionData","customData"]};f.ajax({headers:{Accept:"application/json","Content-Type":"application/json"},url:"/api/checkout/pub/orderForm/"+i+"/attachments/subscriptionData",type:"POST",data:JSON.stringify(e),success:function(t,e,a){"onpage"==p.callback?"modal"==p.after?vtexjs.checkout.getOrderForm().done(function(t){m.orderform(t)}):(minicart.miniCartInit(),f(".carrinho").click()):window.location.href="/checkout#/cart"},error:function(t,e,a){console.log(e)},complete:function(){f(".buy.load").removeClass("load")}})})},30)})},error:function(){console.log("Não foi possível adicionar ao carrinho")},complete:function(){}})},30)},orderform:function(t){console.log(t);var u="",d=0;f.each(t.items,function(t,e){var a,n,s,o,i,r,c,l=e.attachments;l.length&&(a=e.sellingPrice,n=e.name,i=e.quantity,s=e.imageUrl,o=e.productId,e=e.id,r=(a/100).toFixed(2),c=(c=l[0].content)[Object.keys(c)[0]],d+=i*a,u+='<ul class="c-row cartSkuGroup" data-sku="'+e+'" data-product="'+o+'" data-index="'+t+'"><li class="cartSkuImage"><img src="'+s+'" alt="'+n+'"></li><li class="cartSkuDados"><div class="cartSkuName">'+n+'</div><div class="cartSkuQuantity"><div class="c-row cart-qty"><label>Qtde.:</label><span><a class="remove-cart-qty">-</a><input type="text" class="select-qty" maxlength="4" readonly value="'+i+'"><a class="add-cart-qty">+</a></span></div></div><div class="cartSkuPrice">R$ '+r+'</div><div class="cartSkuPeriodicity">'+("1 month"==c?"Mensal":"Bimestral")+'</div><a class="removeItem">×</a></li></ul>'),0!=p.minPrice&&(i=(p.minPrice/100).toFixed(2),r=(d/100).toFixed(2),(c=f(".restante-subscription")).find("h5 .value").html(i),c.find(".total-order").html("R$ "+r),c.find(".total-minimo").html("R$ "+i),c.show(),setTimeout(function(){m.check(d)},100),setTimeout(function(){m.check(d)},100)),f(".items-subscription").html(u),f(".jn-cart").show().removeClass("load"),f("body").addClass("noScroll")})},check:function(t){var e=p.minPrice,a=e-t,n=100*t/e,s=70<n?"ctop":"cbottom";e<t?(f(".cart-subscription").removeClass("disable").attr("href","/checkout#/cart"),f(".restante-subscription .barra").css("width","100%"),f(".restante-subscription").addClass("_ok"),f(".restante-subscription .restante").html("Valor mínimo atingido")):(f(".cart-subscription").addClass("disable").removeAttr("href","/checkout#/cart"),f(".restante-subscription").removeClass("_ok"),f(".restante-subscription .barra").css("width",n+"%"),f(".restante-subscription .restante").html("Restam apenas <span>R$ "+(a/100).toFixed(2)+"</span>")),f(".restante-subscription .total-order").html("R$ "+(t/100).toFixed(2)).css("left",n+"%").removeClass("cbottom ctop").addClass(s)},formatDate:function(t){var e=t.getDate().toString(),a=1==e.length?"0"+e:e,e=(t.getMonth()+1).toString(),e=1==e.length?"0"+e:e;return t.getFullYear()+"-"+e+"-"+a}};m.init()}}(jQuery),$(document).ready(function(){$(".wrap-subscription").vtexSubscription({minPrice:2e4,type:"select",htmButton:"<span>Assinar</span>",showInfo:!0})});